{% extends 'admin/base_site.html' %}
{% block content %}
<div class="container-fluid">

  <!-- Filtros -->
  <form method="get" class="row mb-3">
    <div class="col-md-3">
      <select name="mes" class="form-select">
        {% for m in meses %}
          <option value="{{ m.valor }}" {% if m.valor == mes_atual %}selected{% endif %}>{{ m.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="ano" class="form-select">
        {% for a in anos %}
          <option value="{{ a }}" {% if a == ano_atual %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
  </form>

  <!-- Cards principais -->
  <div class="row mb-4">
    <div class="col-md-2 mb-3">
      <div class="card text-white shadow rounded-3" style="background-color: #28a745;">
        <div class="card-body text-center">
          <h6>Entradas</h6>
          <h4>R$ {{ total_entradas|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-white shadow rounded-3" style="background-color: #dc3545;">
        <div class="card-body text-center">
          <h6>Saídas</h6>
          <h4>R$ {{ total_saidas|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-white shadow rounded-3" style="background-color: #17a2b8;">
        <div class="card-body text-center">
          <h6>Saldo</h6>
          <h4>R$ {{ saldo_mes|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-white shadow rounded-3" style="background-color: #6f42c1;">
        <div class="card-body text-center">
          <h6>Serviços</h6>
          <h4>{{ servicos_qtd }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-white shadow rounded-3" style="background-color: #ffc107;">
        <div class="card-body text-center">
          <h6>Ticket Médio</h6>
          {% if ticket_medio > 0 %}
            <h4>R$ {{ ticket_medio|floatformat:2 }}</h4>
          {% else %}
            <h4>—</h4>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!-- Principais receitas e despesas -->
  <div class="row mb-4 mt-4">
    <div class="col-md-6">
      <h5>Principais Receitas</h5>
      <table class="table table-sm table-striped">
        <thead>
          <tr><th>Descrição</th><th>Valor</th><th>Data</th><th>Categoria</th><th>Recebido por</th></tr>
        </thead>
        <tbody>
          {% for e in principais_entradas %}
            <tr>
              <td>{{ e.descricao|default:"—" }}</td>
              <td>R$ {{ e.valor|floatformat:2 }}</td>
              <td>{{ e.data }}</td>
              <td>{{ e.categoria|default:"—" }}</td>
              <td>{{ e.recebido_por|default:"—" }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="5">Nenhuma entrada</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="col-md-6">
      <h5>Principais Despesas</h5>
      <table class="table table-sm table-striped">
        <thead>
          <tr><th>Descrição</th><th>Valor</th><th>Data</th><th>Categoria</th><th>Pago por</th></tr>
        </thead>
        <tbody>
          {% for s in principais_saidas %}
            <tr>
              <td>{{ s.descricao|default:"—" }}</td>
              <td>R$ {{ s.valor|floatformat:2 }}</td>
              <td>{{ s.data }}</td>
              <td>{{ s.categoria|default:"—" }}</td>
              <td>{{ s.pago_por|default:"—" }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="5">Nenhuma saída</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <!-- Gráficos principais -->
  <div class="row mt-1">
    <div class="col-md-8">
      <canvas id="graficoEntradasSaidas"></canvas>
    </div>
    <div class="col-md-4">
      <canvas id="graficoServicos"></canvas>
    </div>
  </div>

</div>

<!-- Scripts para os gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx1 = document.getElementById('graficoEntradasSaidas').getContext('2d');
  new Chart(ctx1, {
    type: 'line',
    data: {
      labels: {{ entrada_labels|safe }},
      datasets: [
        { label: 'Entradas', data: {{ entrada_data|safe }}, borderColor: 'green', fill: false },
        { label: 'Saídas', data: {{ saida_data|safe }}, borderColor: 'red', fill: false }
      ]
    }
  });

  const ctx2 = document.getElementById('graficoServicos').getContext('2d');
  new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: {{ servicos_labels|safe }},
      datasets: [{
        data: {{ servicos_data|safe }}
      }]
    }
  });
</script>
{% endblock %}
